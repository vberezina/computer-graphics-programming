# –õ–ê–ë–û–†–ê–¢–û–†–ù–ê–Ø –†–ê–ë–û–¢–ê ‚Ññ5. –í–≤–µ–¥–µ–Ω–∏–µ –≤ 3D: Raymarching –∏ SDF
üîù [–í—Å–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã](../../README.md)  
üîô [–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –∏ —à—É–º—ã](../LR4/LR4.md)  
***

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

üîç [–¢–µ–æ—Ä–∏—è](#–¢–µ–æ—Ä–∏—è)  
üí° [–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏](#–ü–æ–ª–µ–∑–Ω—ã–µ-—Å—Å—ã–ª–∫–∏)  
‚öîÔ∏è [–£—á–µ–±–Ω–∞—è –∑–∞–¥–∞—á–∞](#–£—á–µ–±–Ω–∞—è-–∑–∞–¥–∞—á–∞)  
üìã [–ó–∞–¥–∞–Ω–∏—è](#–ó–∞–¥–∞–Ω–∏—è)  
üö© [–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã](#–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ-–≤–æ–ø—Ä–æ—Å—ã)

*** 

## –¢–µ–æ—Ä–∏—è

**Raymarching** ‚Äî —ç—Ç–æ —Ç–µ—Ö–Ω–∏–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è —ç–∫—Ä–∞–Ω–∞ –∏—Å–ø—É—Å–∫–∞–µ—Ç—Å—è –ª—É—á –∏–∑ –∫–∞–º–µ—Ä—ã. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ Ray Tracing, –≥–¥–µ –ª—É—á –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–µ–π, Raymarching ¬´—à–∞–≥–∞–µ—Ç¬ª –≤–¥–æ–ª—å –ª—É—á–∞ –Ω–µ–±–æ–ª—å—à–∏–º–∏ —à–∞–≥–∞–º–∏, –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –ø—Ä–æ–≤–µ—Ä—è—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å—Ü–µ–Ω–µ.

**SDF** ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–ª—è –ª—é–±–æ–π —Ç–æ—á–∫–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ `p` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ** –¥–æ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–ª–∏–∂–∞–π—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞. ¬´–ó–Ω–∞–∫–æ–≤–æ–µ¬ª –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ *–≤–Ω—É—Ç—Ä–∏* –æ–±—ä–µ–∫—Ç–∞ –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ *—Å–Ω–∞—Ä—É–∂–∏*. –ù–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–∞–º—É –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å.

* `SDF(p) > 0`: –¢–æ—á–∫–∞ `p` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–Ω–∞—Ä—É–∂–∏ –æ–±—ä–µ–∫—Ç–∞.
 
* `SDF(p) = 0`: –¢–æ—á–∫–∞ `p` –ª–µ–∂–∏—Ç –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞.
 
* `SDF(p) < 0`: –¢–æ—á–∫–∞ `p` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞.

**–ü—Ä–∏–º–µ—Ä SDF —Å—Ñ–µ—Ä—ã:**
```c++
float sdSphere(vec3 p, float radius) {
    return length(p) - radius;
}
```

–ó–¥–µ—Å—å `p` ‚Äî —Ç–æ—á–∫–∞ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ, –∞ `radius` ‚Äî —Ä–∞–¥–∏—É—Å —Å—Ñ–µ—Ä—ã. –¶–µ–Ω—Ç—Ä —Å—Ñ–µ—Ä—ã –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (0,0,0).

**–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª Raymarching –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:**
1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –∑–∞–¥–∞—ë–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –ª—É—á–∞ `ro` (ray origin) –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `rd` (ray direction).
 
2. **–®–∞–≥**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ `t = 0.0`.
 
5. **–¶–∏–∫–ª**: –ü–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞ —à–∞–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100):
    a. –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –ª—É—á–µ: `p = ro + t * rd`.

    b. –í—ã—á–∏—Å–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ `p` –¥–æ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å—Ü–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é SDF:  
      `d = sceneSDF(p).`

    c. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è:** –ï—Å–ª–∏ `d < epsilon` (–≥–¥–µ `epsilon` ‚Äî –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, 0.001), –∑–Ω–∞—á–∏—Ç, –º—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–≤–µ—Ç –æ–±—ä–µ–∫—Ç–∞.
    
    d. **–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥:** –ï—Å–ª–∏ –º—ã –¥–∞–ª–µ–∫–æ –æ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏, –º—ã –º–æ–∂–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ —à–∞–≥–Ω—É—Ç—å –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ `d: t += d`.
    
    e. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–º–∞—Ö:** –ï—Å–ª–∏ `t` –ø—Ä–µ–≤—ã—Å–∏–ª–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é (`maxDist`), –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ ‚Äî –ª—É—á —É—à–µ–ª –≤ –ø—É—Å—Ç–æ—Ç—É. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞.


## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

1. [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç OpenGL](https://www.opengl.org/)
2. [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ShaderToy](https://www.shadertoy.com/howto)
3. [–°—Ç–∞—Ä–µ–Ω—å–∫–∞—è, –Ω–æ –≤–ø–æ–ª–Ω–µ –ø–æ–ª–µ–∑–Ω–∞—è —Å—Ç–∞—Ç—å—è –Ω–∞ —Ö–∞–±—Ä–µ –ø–æ —à–µ–π–¥–µ—Ä–∞–º –Ω–∞ ShaderToy](https://habr.com/ru/articles/333002/)

## –£—á–µ–±–Ω–∞—è –∑–∞–¥–∞—á–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —à–µ–π–¥–µ—Ä –∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `main` –ø–æ–ª—É—á–∏—Ç–µ UV-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É [-1, 1], —Å —É—á–µ—Ç–æ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω.

```c++
    vec2 uv = (fragCoord * 2.0 - iResolution.xy) / iResolution.y;
```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–∞—á–∞–ª–æ –ª—É—á–∞ (`ro`) –∏ –µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (`rd`). –ü–æ–∫–∞ —Å–¥–µ–ª–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–æ—Å—Ç–æ–π.
```c++
    vec3 ro = vec3(0.0, 0.0, -3.0); // –ö–∞–º–µ—Ä–∞ –æ—Ç–æ–¥–≤–∏–Ω—É—Ç–∞ –Ω–∞–∑–∞–¥ –ø–æ Z
    vec3 rd = normalize(vec3(uv, 1.0)); // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª—É—á–∞
```
> –≠—Ç–æ —Ç–æ–∂–µ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `main`.

3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ SDF –¥–ª—è —Å—Ñ–µ—Ä—ã
```c++
float sdSphere(vec3 p, float radius) {
    return length(p) - radius;
}
```
> –§—É–Ω–∫—Ü–∏—é –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤—ã—à–µ —Ñ—É–Ω–∫—Ü–∏–∏ `main`.

4. –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `map` (–∏–ª–∏ `sceneSDF`), –∫–æ—Ç–æ—Ä–∞—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å—é —Å—Ü–µ–Ω—É. –ü–æ–∫–∞ —ç—Ç–æ –æ–¥–Ω–∞ —Å—Ñ–µ—Ä–∞.

```c++
float map(vec3 p) {
    return sdSphere(p, 1.0); // –°—Ñ–µ—Ä–∞ —Ä–∞–¥–∏—É—Å–∞ 1.0 –≤ —Ü–µ–Ω—Ç—Ä–µ –º–∏—Ä–∞
}
```

5. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–∞–º –∞–ª–≥–æ—Ä–∏—Ç–º Raymarching –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `raymarch`.

```c++

float raymarch(vec3 ro, vec3 rd) {
    float t = 0.0; // —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–¥–æ–ª—å –ª—É—á–∞
    for (int i = 0; i < 100; i++) {
        vec3 p = ro + t * rd;
        float d = map(p); // –ø–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å—Ü–µ–Ω—ã
        if (d < 0.001) { // –º—ã –ø–æ–ø–∞–ª–∏ –≤ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å!
            return t;
        }
        if (t > 100.0) { // –ª—É—á —É–ª–µ—Ç–µ–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ
            break;
        }
        t += d; // —à–∞–≥–∞–µ–º –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–≤–Ω–æ–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É –ø—É—Ç–∏
    }
    return -1.0; // –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
}
```
6. –í `mainImage` –≤—ã–∑–æ–≤–∏—Ç–µ `raymarch` –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ -1, –∑–∞–∫—Ä–∞—Å—å—Ç–µ –ø–∏–∫—Å–µ–ª—å –≤ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞, –∏–Ω–∞—á–µ ‚Äî –≤ –±–µ–ª—ã–π.

```c++
    float t = raymarch(ro, rd);
    vec3 col = vec3(0.5); // —Å–µ—Ä—ã–π —Ñ–æ–Ω

    if (t > 0.0) {
        col = vec3(1.0); //  –±–µ–ª—ã–π –æ–±—ä–µ–∫—Ç
    }

    fragColor = vec4(col, 1.0);
```

–ü–æ–ª–Ω—ã–π –∫–æ–¥:
```c++
float sdSphere(vec3 p, float radius) {
    return length(p) - radius;
}

float map(vec3 p) {
    return sdSphere(p, 1.0); // –°—Ñ–µ—Ä–∞ —Ä–∞–¥–∏—É—Å–∞ 1.0 –≤ —Ü–µ–Ω—Ç—Ä–µ –º–∏—Ä–∞
}

float raymarch(vec3 ro, vec3 rd) {
    float t = 0.0; // —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–¥–æ–ª—å –ª—É—á–∞
    for (int i = 0; i < 100; i++) {
        vec3 p = ro + t * rd;
        float d = map(p); // –ø–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å—Ü–µ–Ω—ã
        if (d < 0.001) { // –º—ã –ø–æ–ø–∞–ª–∏ –≤ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å!
            return t;
        }
        if (t > 100.0) { // –ª—É—á —É–ª–µ—Ç–µ–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ
            break;
        }
        t += d; // —à–∞–≥–∞–µ–º –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–≤–Ω–æ–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É –ø—É—Ç–∏
    }
    return -1.0; // –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
}

void mainImage( out vec4 fragColor, in vec2 fragCoord )
{
    vec2 uv = (fragCoord * 2.0 - iResolution.xy) / iResolution.y;

    vec3 ro = vec3(0.0, 0.0, -3.0); // –ö–∞–º–µ—Ä–∞ –æ—Ç–æ–¥–≤–∏–Ω—É—Ç–∞ –Ω–∞–∑–∞–¥ –ø–æ Z
    vec3 rd = normalize(vec3(uv, 1.0)); // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª—É—á–∞
    
    
    float t = raymarch(ro, rd);
    vec3 col = vec3(0.5); // —Å–µ—Ä—ã–π —Ñ–æ–Ω

    if (t > 0.0) {
        col = vec3(1.0); // —á–±–µ–ª—ã–π –æ–±—ä–µ–∫—Ç
    }

    fragColor = vec4(col, 1.0);
}
```
–ü–æ–ª—É—á–∏–ª—Å—è –±–µ–ª—ã–π –∫—Ä—É–≥ –Ω–∞ —Å–µ—Ä–æ–º —Ñ–æ–Ω–µ:  

![1](./images/1.png)

**–ê –∫–∞–∫ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç–æ–≤?**

1. –†–µ–∞–ª–∏–∑—É–π—Ç–µ SDF –¥–ª—è –∫—É–±–∞ (–±–æ–∫—Å).
```c++
float sdBox(vec3 p, vec3 b) { // b - –ø–æ–ª–æ–≤–∏–Ω—ã —Ä–∞–∑–º–µ—Ä–æ–≤ –∫—É–±–∞ –ø–æ –æ—Å—è–º
    vec3 q = abs(p) - b;
    return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0);
}
```
2. –ò–∑–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é ``map``, —á—Ç–æ–±—ã –æ–Ω–∞ –≤–∫–ª—é—á–∞–ª–∞ –∏ —Å—Ñ–µ—Ä—É, –∏ –∫—É–±. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä `min` –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ (–ª—É—á –ø–æ–ø–∞–¥–µ—Ç –≤ –±–ª–∏–∂–∞–π—à—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å).

```c++
float map(vec3 p) {
    float sphere = sdSphere(p - vec3(-1.2, 0.0, 0.0), 1.0); // –°—Ñ–µ—Ä–∞ —Å–ª–µ–≤–∞
    float box = sdBox(p - vec3(1.2, 0.0, 0.0), vec3(0.7)); // –ö—É–± —Å–ø—Ä–∞–≤–∞
    return min(sphere, box);
}
```
–ü–æ–ª–Ω—ã–π –∫–æ–¥:
```c++
float sdSphere(vec3 p, float radius) {
    return length(p) - radius;
}

float sdBox(vec3 p, vec3 b) { // b - –ø–æ–ª–æ–≤–∏–Ω—ã —Ä–∞–∑–º–µ—Ä–æ–≤ –∫—É–±–∞ –ø–æ –æ—Å—è–º
    vec3 q = abs(p) - b;
    return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0);
}

float map(vec3 p) {
    float sphere = sdSphere(p - vec3(-1.2, 0.0, 0.0), 1.0); // –°—Ñ–µ—Ä–∞ —Å–ª–µ–≤–∞
    float box = sdBox(p - vec3(1.2, 0.0, 0.0), vec3(0.7)); // –ö—É–± —Å–ø—Ä–∞–≤–∞
    return min(sphere, box);
}

float raymarch(vec3 ro, vec3 rd) {
    float t = 0.0; // —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–¥–æ–ª—å –ª—É—á–∞
    for (int i = 0; i < 100; i++) {
        vec3 p = ro + t * rd;
        float d = map(p); // –ø–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å—Ü–µ–Ω—ã
        if (d < 0.001) { // –º—ã –ø–æ–ø–∞–ª–∏ –≤ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å!
            return t;
        }
        if (t > 100.0) { // –ª—É—á —É–ª–µ—Ç–µ–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ
            break;
        }
        t += d; // —à–∞–≥–∞–µ–º –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–≤–Ω–æ–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É –ø—É—Ç–∏
    }
    return -1.0; // –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
}

void mainImage( out vec4 fragColor, in vec2 fragCoord )
{
    vec2 uv = (fragCoord * 2.0 - iResolution.xy) / iResolution.y;

    vec3 ro = vec3(0.0, 0.0, -3.0); // –ö–∞–º–µ—Ä–∞ –æ—Ç–æ–¥–≤–∏–Ω—É—Ç–∞ –Ω–∞–∑–∞–¥ –ø–æ Z
    vec3 rd = normalize(vec3(uv, 1.0)); // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª—É—á–∞
    
  
    float t = raymarch(ro, rd);
    vec3 col = vec3(0.5); // —Å–µ—Ä—ã–π —Ñ–æ–Ω

    if (t > 0.0) {
        col = vec3(1.0); // –±–µ–ª—ã–π –æ–±—ä–µ–∫—Ç
    }

    fragColor = vec4(col, 1.0);
}
```
–¢–µ–ø–µ—Ä—å –Ω–∞ —Å—Ü–µ–Ω–µ –¥–≤–∞ –æ–±—ä–µ–∫—Ç–∞:  

![2](./images/2.png)
> *–ü–æ—á–µ–º—É –∫–≤–∞–¥—Ä–∞—Ç —Ç–∞–∫ —Å—Ç—Ä–∞–Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç?* **–ü–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –∫—É–±!** ü§î –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –Ω–∞–ª–æ–∂–∏–º —Ç–µ–Ω—å –Ω–∞ —Ç—É –≥—Ä–∞–Ω—å –∏ —ç—Ç–æ –±—É–¥–µ—Ç –æ—á–µ–≤–∏–¥–Ω–æüòÉ 

–°–µ–π—á–∞—Å –æ–±—ä–µ–∫—Ç—ã –≤—ã–≥–ª—è–¥—è—Ç ***–ø–ª–æ—Å–∫–∏–º–∏***. –î–æ–±–∞–≤–∏–º –∏–º **–æ–±—ä—ë–º**. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª–∏. **–ù–æ—Ä–º–∞–ª—å** ‚Äî —ç—Ç–æ –≤–µ–∫—Ç–æ—Ä, –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ã–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏. –ï–≥–æ –º–æ–∂–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å —Å –ø–æ–º–æ—â—å—é –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ SDF (–º–µ—Ç–æ–¥ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–Ω–æ—Å—Ç–µ–π).

1. –î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–æ—Ä–º–∞–ª–µ–π:
```c++
vec3 calcNormal(vec3 p) {
    float eps = 0.001; // –º–∞–ª–µ–Ω—å–∫–æ–µ –ø—Ä–∏—Ä–∞—â–µ–Ω–∏–µ
    vec2 h = vec2(eps, 0);
    return normalize(vec3(
        map(p + h.xyy) - map(p - h.xyy), // –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ X
        map(p + h.yxy) - map(p - h.yxy), // –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ Y
        map(p + h.yyx) - map(p - h.yyx)  // –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ Z
    ));
}
```

2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å –æ—Å–≤–µ—â–µ–Ω–∏—è (–º–æ–¥–µ–ª—å –§–æ–Ω–≥–∞). 

–î–ª—è —ç—Ç–æ–≥–æ –≤ –±–ª–æ–∫–µ `if (t > 0.0)` –≤ `mainImage` –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è `p` –∏ –Ω–æ—Ä–º–∞–ª—å `n`.
```c++
if (t > 0.0) {
    vec3 p = ro + rd * t;
    vec3 n = calcNormal(p);
```

–ó–∞—Ç–µ–º –∑–∞–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å–≤–µ—Ç–∞:
```c++
vec3 lightPos = vec3(3.0, 3.0, -3.0);
```

–ò —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ—Å–≤–µ—â–µ–Ω–∏—è: –¥–∏—Ñ—Ñ—É–∑–Ω—É—é (Lambert) –∏ –æ–∫—Ä—É–∂–∞—é—â—É—é (ambient):
```c++
    vec3 lightDir = normalize(lightPos - p);
    float diff = max(dot(n, lightDir), 0.0); // –¥–∏—Ñ—Ñ—É–∑–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è
    vec3 ambient = vec3(0.1); // –æ–∫—Ä—É–∂–∞—é—â–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ

    col = vec3(0.7, 0.2, 0.2) * (ambient + diff); // –∫—Ä–∞—Å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
}
```
–ü–æ–ª–Ω—ã–π –∫–æ–¥:
```c++
float sdSphere(vec3 p, float radius) {
    return length(p) - radius;
}

float sdBox(vec3 p, vec3 b) { // b - –ø–æ–ª–æ–≤–∏–Ω—ã —Ä–∞–∑–º–µ—Ä–æ–≤ –∫—É–±–∞ –ø–æ –æ—Å—è–º
    vec3 q = abs(p) - b;
    return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0);
}

float map(vec3 p) {
    float sphere = sdSphere(p - vec3(-1.2, 0.0, 0.0), 1.0); // –°—Ñ–µ—Ä–∞ —Å–ª–µ–≤–∞
    float box = sdBox(p - vec3(1.2, 0.0, 0.0), vec3(0.7)); // –ö—É–± —Å–ø—Ä–∞–≤–∞
    return min(sphere, box);
}

float raymarch(vec3 ro, vec3 rd) {
    float t = 0.0; // —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–¥–æ–ª—å –ª—É—á–∞
    for (int i = 0; i < 100; i++) {
        vec3 p = ro + t * rd;
        float d = map(p); // –ø–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å—Ü–µ–Ω—ã
        if (d < 0.001) { // –º—ã –ø–æ–ø–∞–ª–∏ –≤ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å!
            return t;
        }
        if (t > 100.0) { // –ª—É—á —É–ª–µ—Ç–µ–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ
            break;
        }
        t += d; // —à–∞–≥–∞–µ–º –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–≤–Ω–æ–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É –ø—É—Ç–∏
    }
    return -1.0; // –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
}

vec3 calcNormal(vec3 p) {
    float eps = 0.001; // –º–∞–ª–µ–Ω—å–∫–æ–µ –ø—Ä–∏—Ä–∞—â–µ–Ω–∏–µ
    vec2 h = vec2(eps, 0);
    return normalize(vec3(
        map(p + h.xyy) - map(p - h.xyy), // –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ X
        map(p + h.yxy) - map(p - h.yxy), // –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ Y
        map(p + h.yyx) - map(p - h.yyx)  // –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ Z
    ));
}

void mainImage( out vec4 fragColor, in vec2 fragCoord )
{
    vec2 uv = (fragCoord * 2.0 - iResolution.xy) / iResolution.y;

    vec3 ro = vec3(0.0, 0.0, -3.0); // –ö–∞–º–µ—Ä–∞ –æ—Ç–æ–¥–≤–∏–Ω—É—Ç–∞ –Ω–∞–∑–∞–¥ –ø–æ Z
    vec3 rd = normalize(vec3(uv, 1.0)); // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª—É—á–∞
    

    float t = raymarch(ro, rd);
    vec3 col = vec3(0.5); // —Å–µ—Ä—ã–π —Ñ–æ–Ω

    if (t > 0.0) {
    vec3 p = ro + rd * t;
    vec3 n = calcNormal(p);
    
    vec3 lightPos = vec3(3.0, 3.0, -3.0);
    
    vec3 lightDir = normalize(lightPos - p);
    float diff = max(dot(n, lightDir), 0.0); // –¥–∏—Ñ—Ñ—É–∑–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è
    vec3 ambient = vec3(0.1); // –æ–∫—Ä—É–∂–∞—é—â–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ

    col = vec3(0.7, 0.2, 0.2) * (ambient + diff); // –∫—Ä–∞—Å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
    }

    fragColor = vec4(col, 1.0);
}
```
–ò –≤–æ—Ç —Ç–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

![3](./images/3.png)

> –¢–µ–ø–µ—Ä—å —ç—Ç–æ —Ç–æ—á–Ω–æ –∫—É–± üòÄ 

## –ó–∞–¥–∞–Ω–∏—è

### –ó–∞–¥–∞–Ω–∏–µ 1. –û–¥–Ω–∞ SDF-—Ñ–∏–≥—É—Ä–∞

–ù–∞–ø–∏—à–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º Raymarching –∏ –¥–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω—É —Ñ–∏–≥—É—Ä—É –Ω–∞ —Å—Ü–µ–Ω—É.


### –ó–∞–¥–∞–Ω–∏–µ 2. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω

–î–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∏–≥—É—Ä –Ω–∞ —Å—Ü–µ–Ω—É.

### –ó–∞–¥–∞–Ω–∏–µ 3. –ú–æ–¥–µ–ª—å –æ—Å–≤–µ—â–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –º–æ–¥–µ–ª—å –æ—Å–≤–µ—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–¥–µ–ª—å –§–æ–Ω–≥–∞), —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ñ–∏–≥—É—Ä—ã –Ω–∞ —Å—Ü–µ–Ω–µ –æ–±—ä–µ–º–Ω—ã–º–∏.





## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

1. –û–±—ä—è—Å–Ω–∏—Ç–µ, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç SDF-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏, –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∏ —Å–Ω–∞—Ä—É–∂–∏ –æ–±—ä–µ–∫—Ç–∞.
 
3. –ü–æ—á–µ–º—É –≤ —Ü–∏–∫–ª–µ Raymarching –º—ã –º–æ–∂–µ–º —à–∞–≥–∞—Ç—å –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–≤–Ω–æ–µ d (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–æ —Å—Ü–µ–Ω—ã)? –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —ç—Ç–∞ –≤–µ–ª–∏—á–∏–Ω–∞?
 
5. –ö–∞–∫ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª–∏ –∫ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –≤ –Ω–∞—à–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º–µ –∏ –¥–ª—è —á–µ–≥–æ –æ–Ω–∏ –Ω—É–∂–Ω—ã?
 
7. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –µ—Å–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ epsilon –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–µ? –ê –µ—Å–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ –Ω—É–ª—è?

